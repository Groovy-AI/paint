<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>paint.a</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {margin:0;height:100vh;display:flex;flex-direction:column;font-family:system-ui,Arial,sans-serif;background:white;}
header {background:#1f1f1f;color:white;padding:12px;text-align:center;font-size:18px;font-weight:600;}
#toolbar {background:#2b2b2b;padding:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
#toolbar label {color:#ccc;font-size:13px;}
button,select,input {background:#3a3a3a;color:white;border:none;padding:5px 8px;border-radius:4px;font-size:13px;}
button:hover {background:#555;}
#canvasWrapper {flex:1;overflow:hidden;background:white;}
#canvasContainer {position:relative;width:100%;height:100%;transform-origin:0 0;}
canvas,#previewCanvas {position:absolute;inset:0;touch-action:none;cursor:crosshair;}
#previewCanvas {pointer-events:none;}
</style>
</head>
<body>
<header>paint.a</header>
<div id="toolbar">
<label>Tool</label>
<select id="tool">
<option value="brush">Brush</option>
<option value="eraser">Eraser</option>
<option value="screenFill">Screen Fill</option>
<option value="rectangle">Rectangle</option>
<option value="circle">Circle</option>
</select>

<label>Color</label>
<input type="color" id="color" value="#000000">

<label>Size</label>
<input type="range" id="size" min="1" max="80" value="6">

<label>Opacity</label>
<input type="range" id="opacity" min="0" max="1" step="0.01" value="1">

<button id="undo">Undo</button>
<button id="redo">Redo</button>

<label>Layer</label>
<select id="layerSelect"></select>

<label>Layer Opacity</label>
<input type="range" id="layerOpacity" min="0" max="1" step="0.01" value="1">

<button id="toggleLayer">Hide</button>
<button id="addLayer">Add</button>

<label>Zoom</label>
<input type="range" id="zoom" min="0.5" max="3" step="0.1" value="1">

<button id="saveProject">Save</button>
<button id="loadProject">Load</button>
<input type="file" id="fileInput" hidden>
</div>

<div id="canvasWrapper">
<div id="canvasContainer"></div>
</div>

<script>
const container=document.getElementById("canvasContainer");
const layerSelect=document.getElementById("layerSelect");
const fileInput=document.getElementById("fileInput");

let layers=[],activeLayer=0,drawing=false;
let startX=0,startY=0;
let tool=document.getElementById("tool").value;
let color=document.getElementById("color").value;
let size=document.getElementById("size").value;
let opacity=document.getElementById("opacity").value;
let zoom=1;
let undoStack=[],redoStack=[];

const previewCanvas=document.createElement("canvas");
previewCanvas.id="previewCanvas";
container.appendChild(previewCanvas);
const previewCtx=previewCanvas.getContext("2d");

/* TOOL / INPUT HANDLERS */
document.getElementById("tool").onchange=e=>tool=e.target.value;
document.getElementById("color").oninput=e=>color=e.target.value;
document.getElementById("size").oninput=e=>size=e.target.value;
document.getElementById("opacity").oninput=e=>opacity=e.target.value;
document.getElementById("zoom").oninput=e=>{zoom=e.target.value;container.style.transform=`scale(${zoom})`;};
document.getElementById("undo").onclick=undo;
document.getElementById("redo").onclick=redo;
document.getElementById("addLayer").onclick=addLayer;
document.getElementById("toggleLayer").onclick=toggleLayer;
document.getElementById("saveProject").onclick=saveProject;
document.getElementById("loadProject").onclick=()=>fileInput.click();
fileInput.onchange=loadProject;
layerSelect.onchange=()=>activeLayer=Number(layerSelect.value);
document.getElementById("layerOpacity").oninput=e=>{const l=layers[activeLayer];l.opacity=e.target.value;l.canvas.style.opacity=l.opacity;};

/* INITIALIZE LAYER */
function addLayer(){
    const canvas=document.createElement("canvas");
    canvas.width=container.clientWidth;
    canvas.height=container.clientHeight;
    container.appendChild(canvas);
    layers.push({canvas,ctx:canvas.getContext("2d"),visible:true,opacity:1});
    activeLayer=layers.length-1;
    updateLayersUI();
}
function updateLayersUI(){
    layerSelect.innerHTML="";
    layers.forEach((_,i)=>{const o=document.createElement("option");o.value=i;o.textContent=`Layer ${i+1}`;if(i===activeLayer)o.selected=true;layerSelect.appendChild(o);});
}

/* UNDO / REDO */
function saveState(){undoStack.push(container.innerHTML);redoStack.length=0;}
function undo(){if(!undoStack.length)return;redoStack.push(container.innerHTML);container.innerHTML=undoStack.pop();rebuildLayers();}
function redo(){if(!redoStack.length)return;undoStack.push(container.innerHTML);container.innerHTML=redoStack.pop();rebuildLayers();}
function rebuildLayers(){layers=[...container.querySelectorAll("canvas")].map(c=>({canvas:c,ctx:c.getContext("2d"),visible:c.style.display!=="none",opacity:c.style.opacity||1}));}

/* DRAW EVENTS */
container.addEventListener("pointerdown",e=>{
    const l=layers[activeLayer];if(!l)return;
    saveState();
    startX=e.offsetX;startY=e.offsetY;
    drawing=true;l.ctx.beginPath();
    if(tool==="brush"||tool==="eraser"){l.ctx.moveTo(e.offsetX,e.offsetY);}
    if(tool==="screenFill"){l.ctx.fillStyle=color;l.ctx.globalAlpha=opacity;l.ctx.fillRect(0,0,l.canvas.width,l.canvas.height);drawing=false;}
});
container.addEventListener("pointermove",e=>{
    const l=layers[activeLayer];if(!drawing||!l)return;
    const ctx=l.ctx;
    if(tool==="brush"||tool==="eraser"){
        ctx.lineWidth=size;ctx.lineCap="round";ctx.globalAlpha=opacity;
        ctx.globalCompositeOperation=tool==="eraser"?"destination-out":"source-over";
        if(tool!=="eraser")ctx.strokeStyle=color;
        ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();
    }
    if(tool==="rectangle"||tool==="circle"){
        previewCanvas.width=container.clientWidth;previewCanvas.height=container.clientHeight;
        previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
        previewCtx.strokeStyle=color;previewCtx.globalAlpha=opacity;previewCtx.lineWidth=size;
        let w=e.offsetX-startX,h=e.offsetY-startY;
        if(e.shiftKey){w=h=Math.max(Math.abs(w),Math.abs(h))*(w<0?-1:1);}
        previewCtx.beginPath();
        if(tool==="rectangle")previewCtx.rect(startX,startY,w,h);
        if(tool==="circle")previewCtx.ellipse(startX+w/2,startY+h/2,Math.abs(w/2),Math.abs(h/2),0,0,2*Math.PI);
        previewCtx.stroke();
    }
});
container.addEventListener("pointerup",e=>{
    const l=layers[activeLayer];if(!drawing||!l)return;
    if(tool==="rectangle"||tool==="circle"){
        const ctx=l.ctx;ctx.strokeStyle=color;ctx.globalAlpha=opacity;ctx.lineWidth=size;
        let w=e.offsetX-startX,h=e.offsetY-startY;
        if(e.shiftKey) w=h=Math.max(Math.abs(w),Math.abs(h))*(w<0?-1:1);
        ctx.beginPath();
        if(tool==="rectangle")ctx.rect(startX,startY,w,h);
        if(tool==="circle")ctx.ellipse(startX+w/2,startY+h/2,Math.abs(w/2),Math.abs(h/2),0,0,2*Math.PI);
        ctx.stroke();
        previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
    }
    drawing=false;
});

/* SAVE / LOAD */
function saveProject(){const data={layers:layers.map(l=>({image:l.canvas.toDataURL(),opacity:l.opacity,visible:l.visible}))};const blob=new Blob([JSON.stringify(data)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="paint.a.json";a.click();}
function loadProject(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{const data=JSON.parse(reader.result);container.innerHTML="";layers=[];data.layers.forEach(l=>{const c=document.createElement("canvas");c.width=container.clientWidth;c.height=container.clientHeight;c.style.opacity=l.opacity;c.style.display=l.visible?"block":"none";const ctx=c.getContext("2d");const img=new Image();img.onload=()=>ctx.drawImage(img,0,0);img.src=l.image;container.appendChild(c);layers.push({canvas:c,ctx,opacity:l.opacity,visible:l.visible});});updateLayersUI();};reader.readAsText(file);}
function toggleLayer(){const l=layers[activeLayer];l.visible=!l.visible;l.canvas.style.display=l.visible?"block":"none";}

/* RESPONSIVE CANVAS */
function resizeCanvas(){
    layers.forEach(l=>{
        const temp=document.createElement("canvas");
        temp.width=l.canvas.width;temp.height=l.canvas.height;
        temp.getContext("2d").drawImage(l.canvas,0,0);
        l.canvas.width=container.clientWidth;
        l.canvas.height=container.clientHeight;
        l.ctx.drawImage(temp,0,0,l.canvas.width,l.canvas.height);
    });
    previewCanvas.width=container.clientWidth;
    previewCanvas.height=container.clientHeight;
}
window.addEventListener("resize",resizeCanvas);

/* INITIALIZE */
addLayer();
resizeCanvas();
</script>
</body>
</html>
